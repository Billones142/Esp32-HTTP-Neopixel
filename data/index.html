<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Neopixel</title>
    <style>

        textarea {
            width: 100%;
            height: 300px;
            font-family: monospace;
            font-size: 14px;
            background-color: #f4f4f4;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            resize: vertical;
        }

        button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #007BFF;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <h1>ESP32 Neopixel</h1>
    <form id="colorForm">
        <h2>Static color</h2>
        <div>
            <label for="index">Índice:</label>
            <input type="number" value="0" id="index" name="i" min="0" required>
            <input name="Color Picker" id="colorValues" type="color" />
        </div>
        <button type="button" onclick="sendData()">Send colour</button>
    </form>
    <form id="scriptForm">
        <h2>Lua script</h2>
        <div>
            <div>   
                <input type="checkbox" id="saveScript" name="saveScript">
                <label for="saveScript">Save script</label>
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="scriptName">Script Name</label>
                <input type="text" id="scriptName" name="scriptName">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label for="script">Script</label>
                <textarea type="text" id="luaScript" name="luaScript" required></textarea>
            </div>
        </div>
        <div>
            <input type="checkbox" id="applyScript" name="applyScript" checked>
            <label for="applyScript">Apply script on upload</label>
        </div>
        <button type="button" onclick="sendScriptData()">Send script</button>
    </form>

    <p id="response"></p>

    <script>
        const textarea = document.getElementById('luaScript');

        textarea.addEventListener('keydown', function (event) {
            if (event.key === 'Tab') {
                event.preventDefault(); // Evita el comportamiento predeterminado de tabulación
                const start = this.selectionStart;
                const end = this.selectionEnd;

                // Inserta 4 espacios en la posición actual del cursor
                const spaces = '    ';
                this.value = this.value.substring(0, start) + spaces + this.value.substring(end);

                // Coloca el cursor justo después de los 4 espacios
                this.selectionStart = this.selectionEnd = start + spaces.length;
            }
        });
        const colorSelector = document.getElementById('colorValues');

        let debounceTimer;
        colorSelector.addEventListener('input', () => {
            clearTimeout(debounceTimer); // Clear the previous timer
            debounceTimer = setTimeout(() => {
                sendData();
            }, 7);

        });

        function updateMessage(message) {
            document.getElementById('response').textContent = message;

        }

        function updateValue(color, value) {
            document.getElementById(`${color}Value`).textContent = value;
        }

        function hexToRgb(hex) {
            const red = parseInt(hex.substring(1, 3), 16); // Extraer y convertir rojo
            const green = parseInt(hex.substring(3, 5), 16); // Extraer y convertir verde
            const blue = parseInt(hex.substring(5, 7), 16); // Extraer y convertir azul
            return { red, green, blue };
        }

        function sendData() {
            const index = document.getElementById('index').value;
            const { red, green, blue } = hexToRgb(colorSelector.value)

            const jsonPayload = {
                colours: [
                    {
                        i: parseInt(index),
                        r: red,
                        g: green,
                        b: blue
                    }
                ]
            };

            document.getElementById('response').textContent = "";
            fetch('http://esp-32.local/setcolor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonPayload)
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('response').textContent = `Respuesta del ESP32: ${data.message}`;
                })
                .catch(error => {
                    document.getElementById('response').textContent = `Error: ${error}`;
                });
        }

        function sendScriptData() {
            const luaScript = document.getElementById('luaScript').value;
            const saveScript = document.getElementById('saveScript').value | false;
            const applyScript = document.getElementById('applyScript').value | true;
            const scriptName = document.getElementById('scriptName').value | "";
            const applySavedScript = document.getElementById('applySavedScript').value | false;

            const jsonPayload = {
                "luaScript" : luaScript,
                "saveScript": saveScript,
                "applyScript": applyScript,
                "scriptName": scriptName,
                "applySavedScript": false,
            };

            document.getElementById('response').textContent = "";
            fetch('http://esp-32.local/setScript', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonPayload)
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('response').textContent = `Respuesta del ESP32: ${data.message}`;
                })
                .catch(error => {
                    document.getElementById('response').textContent = `Error: ${error}`;
                });
        }
    </script>
</body>

</html>